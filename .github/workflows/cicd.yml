name: Java CI (no build tools)

on:
  push:
  pull_request:

jobs:
  build-and-run:
    runs-on: self-hosted
# Use GitHub-hosted runner

    steps:
    # Bước check out code về runner
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Bước compile và chạy smoke test
      - name: Compile
        run: javac simpleWeb.java

      # Bước chạy smoke test
      - name: Smoke test server
        run: |
          java simpleWeb &
          PID=$!

          for i in {1..20}; do
            if curl -fs http://localhost:8080/health; then
              echo "Server OK"
              kill $PID
              exit 0
            fi
            sleep 0.5
          done

          echo "Server failed to start"
          kill $PID || true
          exit 1

      # Deploy - giữ server chạy
      - name: Deploy server
        run: |
          pkill -f "java simpleWeb" || true
          sleep 1
          cd ${{ github.workspace }}
          nohup java simpleWeb > server.log 2>&1 &
          sleep 2
          if curl -fs http://localhost:8080/health; then
            echo "✅ Server deployed successfully on port 8080"
          else
            echo "❌ Server failed to start"
            cat server.log
            exit 1
          fi
