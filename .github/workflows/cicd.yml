name: Java CI (no build tools)

on:
  push:
  pull_request:

jobs:
  build-and-run:
    runs-on: self-hosted
# Use GitHub-hosted runner

    steps:
    # Bước check out code về runner
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Bước compile và chạy smoke test
      - name: Compile
        run: javac simpleWeb.java

      # Bước chạy smoke test
      - name: Smoke test server
        run: |
          java simpleWeb &
          PID=$!

          for i in {1..20}; do
            if curl -fs http://localhost:8080/health; then
              echo "Server OK"
              kill $PID
              exit 0
            fi
            sleep 0.5
          done

          echo "Server failed to start"
          kill $PID || true
          exit 1

      # Deploy - start server in tmux session (keeps running after job)
      - name: Deploy server (tmux)
        run: |
          # Ensure tmux is installed
          if ! command -v tmux >/dev/null 2>&1; then
            echo "tmux not found, installing..."
            sudo apt-get update && sudo apt-get install -y tmux
          fi

          cd ${{ github.workspace }}

          # kill old session if exists
          tmux kill-session -t simpleweb || true

          # start new detached tmux session running the server
          tmux new -d -s simpleweb "cd ${{ github.workspace }} && /usr/bin/java simpleWeb > /tmp/simpleweb.log 2>&1"

          sleep 3
          if curl -fs http://localhost:8080/health; then
            echo "✅ Server deployed in tmux session 'simpleweb'"
            tmux ls || true
          else
            echo "❌ Server failed to start"
            tail -n +1 /tmp/simpleweb.log || true
            exit 1
          fi
      - name: Debug info (tmux, processes, logs)
        run: |
          echo "--- tmux sessions ---"
          tmux ls || true
          echo "--- java processes ---"
          ps aux | grep java | grep -v grep || true
          echo "--- last 100 lines of server log ---"
          tail -n 100 /tmp/simpleweb.log || true

