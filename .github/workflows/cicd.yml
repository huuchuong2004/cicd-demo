name: Java CI (no build tools)

on:
  push:
  pull_request:

jobs:
  build-and-run:
    runs-on: self-hosted
# Use GitHub-hosted runner

    steps:
    # Bước check out code về runner
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Bước compile và chạy smoke test
      - name: Compile
        run: javac simpleWeb.java

      # Bước chạy smoke test
      - name: Smoke test server
        run: |
          java simpleWeb &
          PID=$!

          for i in {1..20}; do
            if curl -fs http://localhost:8080/health; then
              echo "Server OK"
              kill $PID
              exit 0
            fi
            sleep 0.5
          done

          echo "Server failed to start"
          kill $PID || true
          exit 1

      # Deploy - restart systemd service (assumes `simpleweb` service is installed on runner)
      - name: Deploy - restart systemd service
        run: |
          set -eux
          cd ${{ github.workspace }}

          # compile before restarting
          javac simpleWeb.java || true

          # reload systemd (in case unit changed), restart service
          sudo systemctl daemon-reload || true
          sudo systemctl restart simpleweb

          # wait a moment and show status/logs for debugging
          sleep 2
          echo "--- systemctl status simpleweb ---"
          sudo systemctl status simpleweb --no-pager || true
          echo "--- recent journal for simpleweb ---"
          sudo journalctl -u simpleweb -n 200 --no-pager || true
          echo "--- listener on 8080 ---"
          sudo ss -tlnp | grep 8080 || true

